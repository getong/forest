<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Embedded index for the `.forest.car.zst` format."><title>forest_filecoin::db::car::forest::index - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-46f98efaafac5295.ttf.woff2,FiraSans-Regular-018c141bf0843ffd.woff2,FiraSans-Medium-8f9a781e4970d388.woff2,SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2,SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../../../../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../../../../static.files/rustdoc-dd39b87e5fcfba68.css"><meta name="rustdoc-vars" data-root-path="../../../../../" data-static-root-path="../../../../../static.files/" data-current-crate="forest_filecoin" data-themes="" data-resource-suffix="" data-rustdoc-version="1.80.0 (051478957 2024-07-21)" data-channel="1.80.0" data-search-js="search-d52510db62a78183.js" data-settings-js="settings-4313503d2e1961c2.js" ><script src="../../../../../static.files/storage-118b08c4c78b968e.js"></script><script defer src="../sidebar-items.js"></script><script defer src="../../../../../static.files/main-20a3ad099b048cf2.js"></script><noscript><link rel="stylesheet" href="../../../../../static.files/noscript-df360f571f6edeae.css"></noscript><link rel="alternate icon" type="image/png" href="../../../../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../../../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button></nav><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../../../../../forest_filecoin/index.html">forest_filecoin</a><span class="version">0.19.2</span></h2></div><h2 class="location"><a href="#">Module index</a></h2><div class="sidebar-elems"><section><ul class="block"><li><a href="#modules">Modules</a></li><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li><li><a href="#constants">Constants</a></li><li><a href="#traits">Traits</a></li><li><a href="#functions">Functions</a></li></ul></section><h2><a href="../index.html">In forest_filecoin::db::car::forest</a></h2></div></nav><div class="sidebar-resizer"></div><main><div class="width-limiter"><rustdoc-search></rustdoc-search><section id="main-content" class="content"><div class="main-heading"><h1>Module <a href="../../../../index.html">forest_filecoin</a>::<wbr><a href="../../../index.html">db</a>::<wbr><a href="../../index.html">car</a>::<wbr><a href="../index.html">forest</a>::<wbr><a class="mod" href="#">index</a><button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><span class="out-of-band"><a class="src" href="../../../../../src/forest_filecoin/db/car/forest/index/mod.rs.html#3-787">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Embedded index for the <code>.forest.car.zst</code> format.</p>
<p>Maps from <a href="../../../../shim/fvm_latest/kernel/prelude/type.Cid.html" title="type forest_filecoin::shim::fvm_latest::kernel::prelude::Cid"><code>Cid</code></a>s to candidate zstd frame offsets.</p>
<h2 id="design-statement"><a class="doc-anchor" href="#design-statement">§</a>Design statement</h2>
<ul>
<li>Create once, read many times.
This means that existing databases are overkill - most of their API
complexity is for write support.</li>
<li>Embeddable in-file.
This precludes most existing databases, which operate on files or folders.</li>
<li>Lookups must NOT require reading the index into memory.
This precludes using e.g <a href="../../../../../serde/ser/trait.Serialize.html" title="trait serde::ser::Serialize"><code>serde::Serialize</code></a></li>
<li>(Bonus) efficient merging of multiple indices.</li>
</ul>
<h2 id="implementation"><a class="doc-anchor" href="#implementation">§</a>Implementation</h2>
<p>The simplest implementation is a sorted list of <code>(Cid, u64)</code>, pairs.
We’ll call each such pair an <code>entry</code>.
But this simple implementation has a couple of downsides:</p>
<ul>
<li><code>O(log(n))</code> time complexity for searches with binary search.
(We could try to amortise this by doing an initial scan for checkpoints,
but seeking backwards in the file may still be penalised by the OS).</li>
<li>Variable length, possibly large entries on disk, which balloons our size
and/or implementation complexity.</li>
</ul>
<p>We can address this by using an open-addressed hash table with linear probing.</p>
<ul>
<li>“hash table”: Have a linear array</li>
</ul>
<p>We create a linear array of equal-length <a href="enum.Slot.html" title="enum forest_filecoin::db::car::forest::index::Slot"><code>Slot</code></a>s.</p>
<ul>
<li><a href="hash/fn.summary.html" title="fn forest_filecoin::db::car::forest::index::hash::summary">hashing</a> the <a href="../../../../shim/fvm_latest/kernel/prelude/type.Cid.html" title="type forest_filecoin::shim::fvm_latest::kernel::prelude::Cid"><code>Cid</code></a> gives us a fixed length entry.</li>
<li>A <a href="hash/fn.ideal_slot_ix.html" title="fn forest_filecoin::db::car::forest::index::hash::ideal_slot_ix"><code>hash::ideal_slot_ix</code></a> gives us a likely location to find the entry,
given a table size.
(That is, a hash in a collection of length 10 has a different <code>ideal_slot_ix</code>
than if the same hash were in a collection of length 20.)
We insert padding <a href="enum.Slot.html#variant.Empty" title="variant forest_filecoin::db::car::forest::index::Slot::Empty"><code>Slot::Empty</code></a>s to ensure each entry is at or after its
<a href="hash/fn.ideal_slot_ix.html" title="fn forest_filecoin::db::car::forest::index::hash::ideal_slot_ix"><code>ideal_slot_ix</code></a>.</li>
<li>We sort the <a href="util/struct.NonMaximalU64.html" title="struct forest_filecoin::db::car::forest::index::util::NonMaximalU64">hashes</a> from lowest to highest, so lookups can
scan forwards from the <a href="hash/fn.ideal_slot_ix.html" title="fn forest_filecoin::db::car::forest::index::hash::ideal_slot_ix"><code>ideal_slot_ix</code></a> to find the hash they’re looking for.
This is called <em>linear probing</em>.</li>
<li>We have two types of collisions.
Both must be handled by callers of <a href="struct.Reader.html#method.get" title="method forest_filecoin::db::car::forest::index::Reader::get"><code>Reader::get</code></a>.
<ul>
<li>Hash collisions, where two different <a href="../../../../shim/fvm_latest/kernel/prelude/type.Cid.html" title="type forest_filecoin::shim::fvm_latest::kernel::prelude::Cid"><code>Cid</code></a>s have the same hash.</li>
<li><a href="hash/fn.ideal_slot_ix.html" title="fn forest_filecoin::db::car::forest::index::hash::ideal_slot_ix"><code>hash::ideal_slot_ix</code></a> collisions.</li>
</ul>
</li>
<li>A slot is always found at or within <a href="struct.V1Header.html#structfield.longest_distance" title="field forest_filecoin::db::car::forest::index::V1Header::longest_distance"><code>V1Header::longest_distance</code></a> after its
<a href="hash/fn.ideal_slot_ix.html" title="fn forest_filecoin::db::car::forest::index::hash::ideal_slot_ix"><code>hash::ideal_slot_ix</code></a>.
This is calculated at construction time.</li>
</ul>
<p>So the layout on disk is as follows:</p>
<div class="example-wrap"><pre class="language-text"><code>┌──────────────┐
│Version::V1   │
├──────────────┤
│Header        │ &lt;- Contains the &quot;intial width&quot;, required to perform lookups
├──────────────┤
│Slot::Occupied│
├──────────────┤
│Slot::Empty   │
├──────────────┤    The hash table does not know how many slots it contains:
│Slot::Empty   │    Length information must be stored out of band (e.g in the
├──────────────┤ &lt;- Zstd skip frame header)
</code></pre></div></div></details><h2 id="modules" class="section-header">Modules<a href="#modules" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="mod" href="hash/index.html" title="mod forest_filecoin::db::car::forest::index::hash">hash</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li><li><div class="item-name"><a class="mod" href="util/index.html" title="mod forest_filecoin::db::car::forest::index::util">util</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li></ul><h2 id="structs" class="section-header">Structs<a href="#structs" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="struct" href="struct.Builder.html" title="struct forest_filecoin::db::car::forest::index::Builder">Builder</a></div><div class="desc docblock-short">Accumulator of <a href="../../../../shim/fvm_latest/kernel/prelude/type.Cid.html" title="type forest_filecoin::shim::fvm_latest::kernel::prelude::Cid"><code>Cid</code></a>s and frame offsets (<a href="https://doc.rust-lang.org/1.80.0/std/primitive.u64.html" title="primitive u64"><code>u64</code></a>s) for the hash table.</div></li><li><div class="item-name"><a class="struct" href="struct.Iter.html" title="struct forest_filecoin::db::car::forest::index::Iter">Iter</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li><li><div class="item-name"><a class="struct" href="struct.OccupiedSlot.html" title="struct forest_filecoin::db::car::forest::index::OccupiedSlot">OccupiedSlot</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li><li><div class="item-name"><a class="struct" href="struct.RawSlot.html" title="struct forest_filecoin::db::car::forest::index::RawSlot">RawSlot</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">A <a href="enum.Slot.html" title="enum forest_filecoin::db::car::forest::index::Slot"><code>Slot</code></a> as it appears on disk.</div></li><li><div class="item-name"><a class="struct" href="struct.Reader.html" title="struct forest_filecoin::db::car::forest::index::Reader">Reader</a></div><div class="desc docblock-short">Reader for the <code>.forest.car.zst</code>’s embedded index.</div></li><li><div class="item-name"><a class="struct" href="struct.V1Header.html" title="struct forest_filecoin::db::car::forest::index::V1Header">V1Header</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li><li><div class="item-name"><a class="struct" href="struct.Writer.html" title="struct forest_filecoin::db::car::forest::index::Writer">Writer</a></div><div class="desc docblock-short">Writes the actual slot table to disk.</div></li></ul><h2 id="enums" class="section-header">Enums<a href="#enums" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="enum" href="enum.Slot.html" title="enum forest_filecoin::db::car::forest::index::Slot">Slot</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li><li><div class="item-name"><a class="enum" href="enum.Version.html" title="enum forest_filecoin::db::car::forest::index::Version">Version</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li></ul><h2 id="constants" class="section-header">Constants<a href="#constants" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="constant" href="constant.DEFAULT_LOAD_FACTOR.html" title="constant forest_filecoin::db::car::forest::index::DEFAULT_LOAD_FACTOR">DEFAULT_LOAD_FACTOR</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li><li><div class="item-name"><a class="constant" href="constant.__CFG_VIS_ACCUMULATOR_MUST_EXPAND_ONCE_OTHERWISE_IS_A_BUG_3414945615849699168.html" title="constant forest_filecoin::db::car::forest::index::__CFG_VIS_ACCUMULATOR_MUST_EXPAND_ONCE_OTHERWISE_IS_A_BUG_3414945615849699168">__CFG_VIS_ACCUMULATOR_MUST_EXPAND_ONCE_OTHERWISE_IS_A_BUG_3414945615849699168</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li><li><div class="item-name"><a class="constant" href="constant.__CFG_VIS_ACCUMULATOR_MUST_EXPAND_ONCE_OTHERWISE_IS_A_BUG_5046060507417499445.html" title="constant forest_filecoin::db::car::forest::index::__CFG_VIS_ACCUMULATOR_MUST_EXPAND_ONCE_OTHERWISE_IS_A_BUG_5046060507417499445">__CFG_VIS_ACCUMULATOR_MUST_EXPAND_ONCE_OTHERWISE_IS_A_BUG_5046060507417499445</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li><li><div class="item-name"><a class="constant" href="constant.__CFG_VIS_ACCUMULATOR_MUST_EXPAND_ONCE_OTHERWISE_IS_A_BUG_14783731114302892267.html" title="constant forest_filecoin::db::car::forest::index::__CFG_VIS_ACCUMULATOR_MUST_EXPAND_ONCE_OTHERWISE_IS_A_BUG_14783731114302892267">__CFG_VIS_ACCUMULATOR_MUST_EXPAND_ONCE_OTHERWISE_IS_A_BUG_14783731114302892267</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li><li><div class="item-name"><a class="constant" href="constant.__CFG_VIS_ACCUMULATOR_MUST_EXPAND_ONCE_OTHERWISE_IS_A_BUG_16136933264024358035.html" title="constant forest_filecoin::db::car::forest::index::__CFG_VIS_ACCUMULATOR_MUST_EXPAND_ONCE_OTHERWISE_IS_A_BUG_16136933264024358035">__CFG_VIS_ACCUMULATOR_MUST_EXPAND_ONCE_OTHERWISE_IS_A_BUG_16136933264024358035</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li><li><div class="item-name"><a class="constant" href="constant.__CFG_VIS_ACCUMULATOR_MUST_EXPAND_ONCE_OTHERWISE_IS_A_BUG_18087352314444884853.html" title="constant forest_filecoin::db::car::forest::index::__CFG_VIS_ACCUMULATOR_MUST_EXPAND_ONCE_OTHERWISE_IS_A_BUG_18087352314444884853">__CFG_VIS_ACCUMULATOR_MUST_EXPAND_ONCE_OTHERWISE_IS_A_BUG_18087352314444884853</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li></ul><h2 id="traits" class="section-header">Traits<a href="#traits" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="trait" href="trait.Readable.html" title="trait forest_filecoin::db::car::forest::index::Readable">Readable</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li><li><div class="item-name"><a class="trait" href="trait.Writeable.html" title="trait forest_filecoin::db::car::forest::index::Writeable">Writeable</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li></ul><h2 id="functions" class="section-header">Functions<a href="#functions" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="fn" href="fn.initial_width.html" title="fn forest_filecoin::db::car::forest::index::initial_width">initial_width</a><span title="Restricted Visibility">&nbsp;🔒</span> </div></li><li><div class="item-name"><a class="fn" href="fn.written_len.html" title="fn forest_filecoin::db::car::forest::index::written_len">written_len</a><span title="Restricted Visibility">&nbsp;🔒</span> </div><div class="desc docblock-short">Useful for exhaustiveness checking</div></li></ul></section></div></main></body></html>