<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Messages are transactions that produce new states. The state (usually referred to as the ‘state-tree’) is a mapping from actor addresses to actor states. Each block contains the hash of the state-tree that should be used as the starting state when executing the block messages."><title>apply_block_messages in forest_filecoin::state_manager - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-46f98efaafac5295.ttf.woff2,FiraSans-Regular-018c141bf0843ffd.woff2,FiraSans-Medium-8f9a781e4970d388.woff2,SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2,SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../static.files/rustdoc-dd39b87e5fcfba68.css"><meta name="rustdoc-vars" data-root-path="../../" data-static-root-path="../../static.files/" data-current-crate="forest_filecoin" data-themes="" data-resource-suffix="" data-rustdoc-version="1.80.0 (051478957 2024-07-21)" data-channel="1.80.0" data-search-js="search-d52510db62a78183.js" data-settings-js="settings-4313503d2e1961c2.js" ><script src="../../static.files/storage-118b08c4c78b968e.js"></script><script defer src="sidebar-items.js"></script><script defer src="../../static.files/main-20a3ad099b048cf2.js"></script><noscript><link rel="stylesheet" href="../../static.files/noscript-df360f571f6edeae.css"></noscript><link rel="alternate icon" type="image/png" href="../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc fn"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button></nav><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../../forest_filecoin/index.html">forest_filecoin</a><span class="version">0.19.2</span></h2></div><div class="sidebar-elems"><h2><a href="index.html">In forest_filecoin::state_manager</a></h2></div></nav><div class="sidebar-resizer"></div><main><div class="width-limiter"><rustdoc-search></rustdoc-search><section id="main-content" class="content"><div class="main-heading"><h1>Function <a href="../index.html">forest_filecoin</a>::<wbr><a href="index.html">state_manager</a>::<wbr><a class="fn" href="#">apply_block_messages</a><button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><span class="out-of-band"><a class="src" href="../../src/forest_filecoin/state_manager/mod.rs.html#1569-1676">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><pre class="rust item-decl"><code>pub fn apply_block_messages&lt;DB&gt;(
    genesis_timestamp: <a class="primitive" href="https://doc.rust-lang.org/1.80.0/std/primitive.u64.html">u64</a>,
    chain_index: <a class="struct" href="https://doc.rust-lang.org/1.80.0/alloc/sync/struct.Arc.html" title="struct alloc::sync::Arc">Arc</a>&lt;<a class="struct" href="../chain/store/index/struct.ChainIndex.html" title="struct forest_filecoin::chain::store::index::ChainIndex">ChainIndex</a>&lt;<a class="struct" href="https://doc.rust-lang.org/1.80.0/alloc/sync/struct.Arc.html" title="struct alloc::sync::Arc">Arc</a>&lt;DB&gt;&gt;&gt;,
    chain_config: <a class="struct" href="https://doc.rust-lang.org/1.80.0/alloc/sync/struct.Arc.html" title="struct alloc::sync::Arc">Arc</a>&lt;<a class="struct" href="../networks/struct.ChainConfig.html" title="struct forest_filecoin::networks::ChainConfig">ChainConfig</a>&gt;,
    beacon: <a class="struct" href="https://doc.rust-lang.org/1.80.0/alloc/sync/struct.Arc.html" title="struct alloc::sync::Arc">Arc</a>&lt;<a class="struct" href="../beacon/drand/struct.BeaconSchedule.html" title="struct forest_filecoin::beacon::drand::BeaconSchedule">BeaconSchedule</a>&gt;,
    engine: &amp;<a class="struct" href="../shim/machine/struct.MultiEngine.html" title="struct forest_filecoin::shim::machine::MultiEngine">MultiEngine</a>,
    tipset: <a class="struct" href="https://doc.rust-lang.org/1.80.0/alloc/sync/struct.Arc.html" title="struct alloc::sync::Arc">Arc</a>&lt;<a class="struct" href="../blocks/tipset/struct.Tipset.html" title="struct forest_filecoin::blocks::tipset::Tipset">Tipset</a>&gt;,
    callback: <a class="enum" href="https://doc.rust-lang.org/1.80.0/core/option/enum.Option.html" title="enum core::option::Option">Option</a>&lt;impl <a class="trait" href="https://doc.rust-lang.org/1.80.0/core/ops/function/trait.FnMut.html" title="trait core::ops::function::FnMut">FnMut</a>(<a class="struct" href="../interpreter/vm/struct.MessageCallbackCtx.html" title="struct forest_filecoin::interpreter::vm::MessageCallbackCtx">MessageCallbackCtx</a>&lt;'_&gt;) -&gt; <a class="type" href="../../anyhow/type.Result.html" title="type anyhow::Result">Result</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/1.80.0/std/primitive.unit.html">()</a>&gt;&gt;,
    enable_tracing: <a class="enum" href="../interpreter/vm/enum.VMTrace.html" title="enum forest_filecoin::interpreter::vm::VMTrace">VMTrace</a>,
) -&gt; <a class="enum" href="https://doc.rust-lang.org/1.80.0/core/result/enum.Result.html" title="enum core::result::Result">Result</a>&lt;(<a class="type" href="../shim/fvm_latest/kernel/prelude/type.Cid.html" title="type forest_filecoin::shim::fvm_latest::kernel::prelude::Cid">Cid</a>, <a class="type" href="../shim/fvm_latest/kernel/prelude/type.Cid.html" title="type forest_filecoin::shim::fvm_latest::kernel::prelude::Cid">Cid</a>), <a class="struct" href="../../anyhow/struct.Error.html" title="struct anyhow::Error">Error</a>&gt;<div class="where">where
    DB: <a class="trait" href="../../fvm_ipld_blockstore/trait.Blockstore.html" title="trait fvm_ipld_blockstore::Blockstore">Blockstore</a> + <a class="trait" href="https://doc.rust-lang.org/1.80.0/core/marker/trait.Send.html" title="trait core::marker::Send">Send</a> + <a class="trait" href="https://doc.rust-lang.org/1.80.0/core/marker/trait.Sync.html" title="trait core::marker::Sync">Sync</a> + 'static,</div></code></pre><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Messages are transactions that produce new states. The state (usually
referred to as the ‘state-tree’) is a mapping from actor addresses to actor
states. Each block contains the hash of the state-tree that should be used
as the starting state when executing the block messages.</p>
<h2 id="execution-environment"><a class="doc-anchor" href="#execution-environment">§</a>Execution environment</h2>
<p>Transaction execution has the following inputs:</p>
<ul>
<li>a current state-tree (stored as IPLD in a key-value database). This
reference is in <a href="../blocks/tipset/struct.Tipset.html#method.parent_state" title="method forest_filecoin::blocks::tipset::Tipset::parent_state"><code>Tipset::parent_state</code></a>.</li>
<li>up to 900 past state-trees. See
<a href="https://docs.filecoin.io/reference/general/glossary/#finality">https://docs.filecoin.io/reference/general/glossary/#finality</a>.</li>
<li>up to 900 past tipset IDs.</li>
<li>a deterministic source of randomness.</li>
<li>the circulating supply of FIL (see
<a href="https://filecoin.io/blog/filecoin-circulating-supply/">https://filecoin.io/blog/filecoin-circulating-supply/</a>). The circulating
supply is determined by the epoch and the states of a few key actors.</li>
<li>the base fee (see <a href="https://spec.filecoin.io/systems/filecoin_vm/gas_fee/">https://spec.filecoin.io/systems/filecoin_vm/gas_fee/</a>).
This value is defined by <code>tipset.parent_base_fee</code>.</li>
<li>the genesis timestamp (UNIX epoch time when the first block was
mined/created).</li>
<li>a chain configuration (maps epoch to network version, has chain specific
settings).</li>
</ul>
<p>The result of running a set of block messages is an index to the final
state-tree and an index to an array of message receipts (listing gas used,
return codes, etc).</p>
<h2 id="cron-and-null-tipsets"><a class="doc-anchor" href="#cron-and-null-tipsets">§</a>Cron and null tipsets</h2>
<p>Once per epoch, after all messages have run, a special ‘cron’ transaction
must be executed. The tasks of the ‘cron’ transaction include running batch
jobs and keeping the state up-to-date with the current epoch.</p>
<p>It can happen that no blocks are mined in an epoch. The tipset for such an
epoch is called a null tipset. A null tipset has no identity and cannot be
directly executed. This is a problem for ‘cron’ which must run for every
epoch, even if there are no messages. The fix is to run ‘cron’ if there are
any null tipsets between the current epoch and the parent epoch.</p>
<p>Imagine the blockchain looks like this with a null tipset at epoch 9:</p>
<div class="example-wrap"><pre class="language-text"><code>┌────────┐ ┌────┐ ┌───────┐  ┌───────┐
│Epoch 10│ │Null│ │Epoch 8├──►Epoch 7├─►
└───┬────┘ └────┘ └───▲───┘  └───────┘
    └─────────────────┘
</code></pre></div>
<p>The parent of tipset-epoch-10 is tipset-epoch-8. Before executing the
messages in epoch 10, we have to run cron for epoch 9. However, running
‘cron’ requires the timestamp of the youngest block in the tipset (which
doesn’t exist because there are no blocks in the tipset). Lotus dictates that
the timestamp of a null tipset is <code>30s * epoch</code> after the genesis timestamp.
So, in the above example, if the genesis block was mined at time <code>X</code>, the
null tipset for epoch 9 will have timestamp <code>X + 30 * 9</code>.</p>
<h2 id="migrations"><a class="doc-anchor" href="#migrations">§</a>Migrations</h2>
<p>Migrations happen between network upgrades and modify the state tree. If a
migration is scheduled for epoch 10, it will be run <em>after</em> the messages for
epoch 10. The tipset for epoch 11 will link the state-tree produced by the
migration.</p>
<p>Example timeline with a migration at epoch 10:</p>
<ol>
<li>Tipset-epoch-10 executes, producing state-tree A.</li>
<li>Migration consumes state-tree A and produces state-tree B.</li>
<li>Tipset-epoch-11 executes, consuming state-tree B (rather than A).</li>
</ol>
<p>Note: The migration actually happens when tipset-epoch-11 executes. This is
because tipset-epoch-10 may be null and therefore not executed at all.</p>
<h2 id="caching"><a class="doc-anchor" href="#caching">§</a>Caching</h2>
<p>Scanning the blockchain to find past tipsets and state-trees may be slow.
The <code>ChainStore</code> caches recent tipsets to make these scans faster.</p>
</div></details></section></div></main></body></html>