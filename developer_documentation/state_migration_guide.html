<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>State migration guide</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">User Guide</li><li class="chapter-item expanded "><a href="../introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../basic_usage.html"><strong aria-hidden="true">1.1.</strong> Basic Usage</a></li><li class="chapter-item expanded "><a href="../cli.html"><strong aria-hidden="true">1.2.</strong> Command-line interface</a></li><li class="chapter-item expanded "><a href="../wallet.html"><strong aria-hidden="true">1.3.</strong> Wallet handling</a></li><li class="chapter-item expanded "><a href="../configuration.html"><strong aria-hidden="true">1.4.</strong> Configuration</a></li><li class="chapter-item expanded "><a href="../environment_variables.html"><strong aria-hidden="true">1.5.</strong> Environment Variables</a></li><li class="chapter-item expanded "><a href="../docker.html"><strong aria-hidden="true">1.6.</strong> Docker</a></li><li class="chapter-item expanded "><a href="../healthcheck.html"><strong aria-hidden="true">1.7.</strong> Healthcheck</a></li><li class="chapter-item expanded "><a href="../snapshot_export.html"><strong aria-hidden="true">1.8.</strong> Snapshot exporting</a></li><li class="chapter-item expanded "><a href="../jsonrpc.html"><strong aria-hidden="true">1.9.</strong> JSON-RPC API</a></li><li class="chapter-item expanded "><a href="../backups.html"><strong aria-hidden="true">1.10.</strong> Backups</a></li><li class="chapter-item expanded "><a href="../trouble_shooting.html"><strong aria-hidden="true">1.11.</strong> Troubleshooting</a></li><li class="chapter-item expanded "><a href="../glossary.html"><strong aria-hidden="true">1.12.</strong> Glossary</a></li><li class="chapter-item expanded "><a href="../bootstrap_node.html"><strong aria-hidden="true">1.13.</strong> Bootstrap node</a></li><li class="chapter-item expanded "><a href="../offline-forest.html"><strong aria-hidden="true">1.14.</strong> Offline Forest</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Developer documentation</li><li class="chapter-item expanded "><a href="../developer_documentation/introduction.html"><strong aria-hidden="true">2.</strong> Developer documentation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../developer_documentation/application_architecture.html"><strong aria-hidden="true">2.1.</strong> Application architecture</a></li><li class="chapter-item expanded "><a href="../developer_documentation/contributing.html"><strong aria-hidden="true">2.2.</strong> Contributing</a></li><li class="chapter-item expanded "><a href="../developer_documentation/database_migrations.html"><strong aria-hidden="true">2.3.</strong> Database migrations</a></li><li class="chapter-item expanded "><a href="../developer_documentation/local_actions.html"><strong aria-hidden="true">2.4.</strong> Local GH Actions</a></li><li class="chapter-item expanded "><a href="../developer_documentation/mainnet_compatibility.html"><strong aria-hidden="true">2.5.</strong> Mainnet compatibility</a></li><li class="chapter-item expanded "><a href="../developer_documentation/memory-analysis.html"><strong aria-hidden="true">2.6.</strong> Memory analysis</a></li><li class="chapter-item expanded "><a href="../developer_documentation/release_checklist.html"><strong aria-hidden="true">2.7.</strong> Release checklist</a></li><li class="chapter-item expanded "><a href="../developer_documentation/state_migration.html"><strong aria-hidden="true">2.8.</strong> State migration</a></li><li class="chapter-item expanded "><a href="../developer_documentation/state_migration_guide.html" class="active"><strong aria-hidden="true">2.9.</strong> State migration guide</a></li><li class="chapter-item expanded "><a href="../developer_documentation/state_migration_spike.html"><strong aria-hidden="true">2.10.</strong> State migration spike NV17-NV18</a></li><li class="chapter-item expanded "><a href="../developer_documentation/test_plan.html"><strong aria-hidden="true">2.11.</strong> Test plan</a></li><li class="chapter-item expanded "><a href="../developer_documentation/devnet_notes.html"><strong aria-hidden="true">2.12.</strong> Devnet Notes</a></li><li class="chapter-item expanded "><a href="../developer_documentation/archie_and_fuzzy.html"><strong aria-hidden="true">2.13.</strong> Archie and Fuzzy</a></li><li class="chapter-item expanded "><a href="../developer_documentation/rpc_api_compatibility.html"><strong aria-hidden="true">2.14.</strong> RPC API Compatibility</a></li><li class="chapter-item expanded "><a href="../developer_documentation/notes_and_sketches.html"><strong aria-hidden="true">2.15.</strong> Notes and sketches</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../developer_documentation/chain_muxer_state_machine.html"><strong aria-hidden="true">2.15.1.</strong> ChainMuxer/TipsetProcessor state machine</a></li></ol></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="state-migration-guide-"><a class="header" href="#state-migration-guide-">State migration guide ⏩</a></h2>
<p>This guide is intended to help to implement new state migration in the future.
It will be based on the current state migration implementation for NV18 and
NV19.</p>
<h3 id="state-migration-requirements"><a class="header" href="#state-migration-requirements">State migration requirements</a></h3>
<ul>
<li>The proper actor bundle is released for at least the test network. It should
be available on the
<a href="https://github.com/filecoin-project/builtin-actors/releases">actor bundles repository</a>.
You can verify which upgrade needs which bundle in the
<a href="https://github.com/filecoin-project/core-devs/tree/master/Network%20Upgrades">network upgrade matrix</a>.</li>
<li>The state migration should be implemented in the
<a href="https://github.com/filecoin-project/go-state-types/tree/master/builtin">Go library</a>.
This is the source of truth for the state migration. Also, we should carefully
analyze the FIPs and implement the migration based on them. In case of doubt,
we should always consider the FIPs as the source of truth and reach out to the
Lotus team if we find potential issues in their implementation.</li>
</ul>
<h3 id="development"><a class="header" href="#development">Development</a></h3>
<h4 id="import-the-actor-bundle"><a class="header" href="#import-the-actor-bundle">Import the actor bundle</a></h4>
<p>The first step is to import the actor bundle into Forest. This is done by:</p>
<ul>
<li>adding the bundle cid to the <code>HeightInfos</code> struct in the network definitions
files (e.g.,
<a href="https://github.com/ChainSafe/forest/blob/main/src/networks/calibnet/mod.rs">calibnet</a>).</li>
</ul>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>HeightInfo {
    height: Height::Hygge,
    epoch: 322_354,
    bundle: Some(Cid::try_from("bafy2bzaced25ta3j6ygs34roprilbtb3f6mxifyfnm7z7ndquaruxzdq3y7lo").unwrap()),
}
<span class="boring">}</span></code></pre></pre>
<ul>
<li>
<p>adding the bundle manifest cid and url to the <code>ACTOR_BUNDLES</code> in the
<code>src/networks/actors_bundle.rs</code>.</p>
</li>
<li>
<p>ensuring the bundle is mirrored in Forest's DO space under
<code>https://forest-snapshots.fra1.cdn.digitaloceanspaces.com/actors/</code>.</p>
</li>
</ul>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>"bafy2bzacecnhaiwcrpyjvzl4uv4q3jzoif26okl3m66q3cijp3dfwlcxwztwo" @ "v11.0.0" for "mainnet",
},
<span class="boring">}</span></code></pre></pre>
<h3 id="implement-the-migration"><a class="header" href="#implement-the-migration">Implement the migration</a></h3>
<p>The next step is to implement the migration itself. In this guide, we will take
the <code>translate Go code into Rust</code> approach. It's not the cleanest way to do it,
but it's the easiest. Note that the Forest state migration design is not the
same as the Lotus one (we tend to avoid code duplications), so we must be
careful when translating the code.</p>
<h4 id="create-the-migration-module"><a class="header" href="#create-the-migration-module">Create the migration module</a></h4>
<p>Create the nvXX migration module in the
<a href="https://github.com/ChainSafe/forest/tree/main/src/state_migration">state migration module</a>.
A valid approach is just to copy-paste the previous migration module and modify
it accordingly. The files that will most likely be present:</p>
<ul>
<li><code>mod.rs</code>: here we bundle our migration modules and export the final migration
function, defining the state types before and after migration, implementing
the common system migrator and the verifier</li>
<li><code>migration.rs</code>: the heart of the migration. Here we add the migration logic
for each actor. Its Go equivalent is the
<a href="https://github.com/filecoin-project/go-state-types/blob/master/builtin/v10/migration/top.go">top.go</a>,
in case of NV18,</li>
</ul>
<p>We will most likely need as many custom migrators as there are in the Go
implementation. In other terms, if you see that the Go
<a href="https://github.com/filecoin-project/go-state-types/tree/master/builtin/v10/migration">migration</a>
contains:</p>
<ul>
<li><code>eam.go</code> - Ethereum Account Manager migration,</li>
<li><code>init.go</code> - Init actor migration,</li>
<li><code>system.go</code> - System actor migration,</li>
</ul>
<p>Then our implementation will need to define those as well.</p>
<h4 id="the-actual-migration"><a class="header" href="#the-actual-migration">The actual migration</a></h4>
<p>This part will largely depend on the complexity of the network upgrade itself.
The goal is to translate the <code>MigrateStateTree</code> method from
<a href="https://github.com/filecoin-project/go-state-types/blob/master/builtin/v10/migration/top.go#L28">Go</a>
to the <code>add_nvXX_migrations</code> in the <code>migration.rs</code> file. The
<code>add_nvXX_migrations</code> method is responsible for adding all the migrations that
are needed for the network upgrade and the logic in between. Note that the
Forest version is much simpler as it doesn't contain the migration <code>engine</code>
(implemented in the base module).</p>
<p>The first thing to do is to get the current system actor state and the current
manifest. Then we will map the old actor codes to the new ones.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let state_tree = StateTree::new_from_root(store.clone(), state)?;
let system_actor = state_tree
    .get_actor(&amp;Address::new_id(0))?
    .ok_or_else(|| anyhow!("system actor not found"))?;

let system_actor_state = store
    .get_cbor::&lt;SystemStateOld&gt;(&amp;system_actor.state)?
    .ok_or_else(|| anyhow!("system actor state not found"))?;

let current_manifest = Manifest::load_with_actors(&amp;store, &amp;system_actor_state.builtin_actors, 1)?;

let new_manifest = Manifest::load(&amp;store, &amp;new_manifest, version)?;

<span class="boring">}</span></code></pre></pre>
<p>⚠️ Stay vigilant! The <code>StateTree</code> versioning is independent of the network and
actor versioning. At the time of writing, the following holds:</p>
<ul>
<li><code>StateTreeVersion0</code> - Actors version &lt; v2</li>
<li><code>StateTreeVersion1</code> - Actors version v2</li>
<li><code>StateTreeVersion2</code> - Actors version v3</li>
<li><code>StateTreeVersion3</code> - Actors version v4</li>
<li><code>StateTreeVersion4</code> - Actors version v5 up to v9</li>
<li><code>StateTreeVersion5</code> - Actors version v10 and above These are not compatible
with each other and when using a new FVM, we can only use the latest one.</li>
</ul>
<p>For actors that don't need any state migration, we can use the <code>nil_migrator</code>.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>for (name, code) in current_manifest.builtin_actors() {
    let new_code = new_manifest.code_by_name(name)?;
    self.add_migrator(*code, nil_migrator(*new_code));
}
<span class="boring">}</span></code></pre></pre>
<p>For each actor with non-trivial migration logic, we add the migration function.
For example, for the <code>init</code> actor, we have:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>self.add_migrator(
  *current_manifest.get_init_code(),
  init::init_migrator(*new_manifest.get_init_code()),
);
<span class="boring">}</span></code></pre></pre>
<p>and we define the <code>init_migrator</code> in a separate module. This logic may include
setting some defaults on the new fields, changing the current ones to an
upgraded version and so on.</p>
<h4 id="verifier"><a class="header" href="#verifier">Verifier</a></h4>
<p>An optional (but recommended) piece of code that performs some sanity checks on
the state migration definition. At the time of writing, it checks that all
builtin actors are assigned a migration function.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let verifier = Arc::new(Verifier::default());
<span class="boring">}</span></code></pre></pre>
<h4 id="post-migration-actions"><a class="header" href="#post-migration-actions">Post-migration actions</a></h4>
<p>Some code, like creating an entirely new actor (in the case of NV18 creating EAM
and Ethereum Account actors), needs to be executed post-migration. This is done
in the post-migration actions.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>self.add_post_migrator(Arc::new(EamPostMigrator));

self.add_post_migrator(Arc::new(EthAccountPostMigrator));
<span class="boring">}</span></code></pre></pre>
<h4 id="creating-the-migration-object-and-running-it"><a class="header" href="#creating-the-migration-object-and-running-it">Creating the migration object and running it</a></h4>
<p>We take all the migrations that we have defined previously, all the
post-migration actions, and create the migration object.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let mut migration = StateMigration::&lt;DB&gt;::new(Some(verifier), post_migration_actions);
migration.add_nv18_migrations(blockstore.clone(), state, &amp;new_manifest_cid)?;

let actors_in = StateTree::new_from_root(blockstore.clone(), state)?;
let actors_out = StateTree::new(blockstore.clone(), StateTreeVersion::V5)?;
let new_state =
migration.migrate_state_tree(blockstore.clone(), epoch, actors_in, actors_out)?;

Ok(new_state)
<span class="boring">}</span></code></pre></pre>
<p>The new state is the result of the migration.</p>
<h3 id="use-the-migration"><a class="header" href="#use-the-migration">Use the migration</a></h3>
<p>After completing the migration, we need to invoke it at the proper height. This
is done in the <code>handle_state_migrations</code> method in the
<a href="https://github.com/ChainSafe/forest/blob/main/blockchain/state_manager/src/lib.rs">state manager</a>.
This step could be potentially done automatically in the future.</p>
<h3 id="testing"><a class="header" href="#testing">Testing</a></h3>
<p>We currently lack a framework for properly testing the network upgrades before
they actually happen. This should change in the future.</p>
<p>For now, we can do it using a snapshot generated after the network upgrade,
e.g., 100 epochs after and validating previous epochs which should include the
upgrade height.</p>
<pre><code class="language-shell">forest --chain calibnet --encrypt-keystore false --halt-after-import --height=-200 --import-snapshot &lt;SNAPSHOT&gt;
</code></pre>
<h3 id="test-first-development"><a class="header" href="#test-first-development">Test first development</a></h3>
<p>When the Go migration code to translate from is large(e.g. nv17), it makes
development much easier to be able to attach debuggers. Follow below steps to
create simple unit tests for both Rust and Go with real calibnet or mainnet data
and attach debuggers when needed during development.</p>
<ul>
<li>
<p>Get input state cid. Run
<code>forest --chain calibnet --encrypt-keystore false --halt-after-import --height=-200 --import-snapshot &lt;SNAPSHOT&gt;</code>,
the input state cid will be in the failure messages <code>Previous state: &lt;CID&gt;</code>.
And the expected output state cid can be found in state mismatch error
messages.</p>
</li>
<li>
<p>Export input state by running
<code>forest-cli state fetch &lt;PREVIOUS_STATE_CID&gt; &lt;PREVIOUS_STATE_CID&gt;.car</code></p>
</li>
<li>
<p>Compress the car file by running <code>zstd &lt;PREVIOUS_STATE_CID&gt;.car</code></p>
</li>
<li>
<p>Move the compressed car file to data folder <code>src/state_migration/tests/data</code></p>
</li>
<li>
<p>Create a Rust test in <code>src/state_migration/tests/mod.rs</code>. Note: the output CID
does not need to be correct to attach a debugger during development.</p>
<p>Example test for nv17 on calibnet:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[tokio::test]
async fn test_nv17_state_migration_calibnet() -&gt; Result&lt;()&gt; {
    test_state_migration(
        Height::Shark,
        NetworkChain::Calibnet,
        Cid::from_str("bafy2bzacedxtdhqjsrw2twioyaeomdk4z7umhgfv36vzrrotjb4woutphqgyg")?,
        Cid::from_str("bafy2bzacecrejypa2rqdh3geg2u3qdqdrejrfqvh2ykqcrnyhleehpiynh4k4")?,
    )
    .await
}
<span class="boring">}</span></code></pre></pre>
</li>
<li>
<p>Create a Go test in <code>src/state_migration/go-test/state_migration_test.go</code>.
Note: <code>newManifestCid</code> is the bundle CID, epoch is the height that migration
happens.
<a href="https://code.visualstudio.com/docs/languages/go#_debugging">Instruction</a> on
debugging Go code in VS Code.</p>
<p>Example test for nv17 on calibnet:</p>
<pre><code class="language-go">func TestStateMigrationNV17(t *testing.T) {
  startRoot := cid.MustParse("bafy2bzacedxtdhqjsrw2twioyaeomdk4z7umhgfv36vzrrotjb4woutphqgyg")
  newManifestCid := cid.MustParse("bafy2bzacedbedgynklc4dgpyxippkxmba2mgtw7ecntoneclsvvl4klqwuyyy")
  epoch := abi.ChainEpoch(16800)

  bs := migration9Test.NewSyncBlockStoreInMemory()
  ctx := context.Background()

  loadCar(t, ctx, bs, fmt.Sprintf("%s/.local/share/forest/bundles/calibnet/bundle_Shark.car", os.Getenv("HOME")))
  loadCompressedCar(t, ctx, bs, fmt.Sprintf("../data/%s.car.zst", startRoot))

  runStateMigration(t, ctx, cbor.NewCborStore(bs), startRoot, newManifestCid, epoch)
}
</code></pre>
</li>
</ul>
<h3 id="performance-considerations"><a class="header" href="#performance-considerations">Performance considerations</a></h3>
<p>Mainnet upgrades can take a long time even on a powerful machine, due to the
size of the state. It's useful to test beforehand how long (roughly) will a
migration take to better prepare ourselves and signal potential issues to other
implementation teams.</p>
<p>One <em>trick</em> to test this is to:</p>
<ul>
<li>download any recent mainnet snapshot,</li>
<li>change the schedule for the migration to happen 10 epochs before the
snapshot's height,</li>
<li>import the snapshot (on a clean database) and validate the migration epoch (or
a range including that epoch)</li>
</ul>
<p>For example, with the scheduled migration at 3411547, we can run:</p>
<pre><code>forest --encrypt-keystore false --import-snapshot forest_snapshot_mainnet_2023-11-22_height_3411557.forest.car.zst --height=-20
</code></pre>
<p>While the migration itself should succeed, there will be a state mismatch
afterwards. This is not an issue.</p>
<pre><code>2023-12-05T15:46:37.988136Z  INFO forest_filecoin::state_migration: State migration at height Watermelon(epoch 3411547) was successful, Previous state: bafy2bzacedqswtcnhub5ea6upcjp4s7ghba5lgxri7ckezgsdxbkgnh6oyz3w, new state: bafy2bzacecxvz7jl3pt3ki4cirp4arfbmdxxcdb2ni4mzhkbbxqaug5z747gu, new state actors: bafy2bzaceb53kdtubm74czvthzah5inpejrrw7tdueajuhp3n7pbirzjwpqok. Took: 349.9679s.
2023-12-05T15:46:42.438174Z ERROR forest_filecoin::state_manager: state mismatch height=3411549 expected_state=Cid(bafy2bzacecr6ll3w6kb5cyvcsl2e5z6wqrbhaxntzaabkbqikmhuj5a7ukbxk) expected_receipt=Cid(bafy2bzacebhp2zlhpabxgquiht7cu5rqug5sxtxyfadkiijdpaxmcrhdyfs3s) actual_state=Cid(bafy2bzacecjb4tc4hub2yytxdsr7kpozdabufgsvdixqkkllg3yqv7zxujs2g) actual_receipt=Cid(bafy2bzaceaqdlwllmddokd5izwvf7isqlzglueqcw62ttyn5j3nx2hzk4ecwg)
</code></pre>
<p>While the resulting state might be incorrect (not matching what Lotus
calculated), at least we verify that the migration isn't causing OOMs and takes
reasonable amount of time.</p>
<h3 id="future-considerations"><a class="header" href="#future-considerations">Future considerations</a></h3>
<ul>
<li>Grab the actor bundles from the IPFS. This would make Forest less dependent on
the Github infrastructure.
<a href="https://github.com/ChainSafe/forest/issues/2765">Issue #2765</a></li>
<li>Consider pre-migrations as Lotus does. It is not needed at the moment (the
mainnet upgrade takes several seconds at most) but may become a bottleneck if
the migration is too heavy.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../developer_documentation/state_migration.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../developer_documentation/state_migration_spike.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../developer_documentation/state_migration.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../developer_documentation/state_migration_spike.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
